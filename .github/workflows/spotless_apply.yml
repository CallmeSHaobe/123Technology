name: Spotless Format and Auto PR

on:
  workflow_dispatch:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  spotless-format-and-pr:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
      
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && !contains(github.head_ref, 'spotless-fixes')) ||
      (github.event_name == 'push' && github.ref_type == 'branch' && !contains(github.ref, 'spotless/') && !contains(github.actor, 'github-actions'))
      
    outputs:
      changes: ${{ steps.spotless_apply.outputs.changes }}
      fixed_branch: ${{ steps.create_branch.outputs.fixed_branch }}
      
    steps:
    - name: Install Ubuntu dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y mesa-utils xvfb x11-xserver-utils

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.head_ref || github.ref }}

    - name: Set up JDK versions
      uses: actions/setup-java@v4
      with:
        java-version: |
          8
          17
          21
        distribution: 'zulu'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Run Spotless Apply
      id: spotless_apply
      run: |
        echo "è¿è¡Œ Spotless æ ¼å¼åŒ–..."
        ./gradlew --build-cache --info --stacktrace spotlessApply
        
        echo "æ£€æŸ¥æ–‡ä»¶æ›´æ”¹..."
        git status
        git diff --name-only
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹ï¼ˆåŒ…æ‹¬æœªæš‚å­˜çš„æ›´æ”¹ï¼‰
        if ! git diff --quiet || ! git diff --staged --quiet; then
          echo "æ£€æµ‹åˆ°ä»£ç æ ¼å¼åŒ–æ›´æ”¹"
          echo "changes=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå…·ä½“çš„æ›´æ”¹
          echo "å…·ä½“çš„æ–‡ä»¶æ›´æ”¹ï¼š"
          git diff --name-only
          git diff --stat
        else
          echo "æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç æ ¼å¼åŒ–æ›´æ”¹"
          echo "changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Create and push fixed branch
      if: steps.spotless_apply.outputs.changes == 'true'
      run: |
        # è®¾ç½® git é…ç½®
        git config user.name "GitHub Actions"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # åˆ›å»ºå”¯ä¸€çš„åˆ†æ”¯å
        TIMESTAMP=$(date +%s)
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          PR_BRANCH="${{ github.head_ref }}"
          # æ¸…ç†åˆ†æ”¯åä¸­çš„ç‰¹æ®Šå­—ç¬¦
          CLEAN_BRANCH=$(echo "${PR_BRANCH}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          FIXED_BRANCH="${CLEAN_BRANCH}-spotless-fixes-${TIMESTAMP}"
        else
          FIXED_BRANCH="spotless/auto-format-${TIMESTAMP}"
        fi
        
        echo "åˆ›å»ºåˆ†æ”¯: ${FIXED_BRANCH}"
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹å¹¶æäº¤
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹å¯ä»¥æäº¤
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          echo "changes=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # åˆ‡æ¢åˆ°æ–°åˆ†æ”¯å¹¶æäº¤æ›´æ”¹
        git checkout -b "${FIXED_BRANCH}"
        git commit -m "ğŸ”§ Apply spotless code formatting" -m "Automated formatting fixes by GitHub Actions"
        
        # æ¨é€åˆ†æ”¯
        git push origin "${FIXED_BRANCH}"
        
        # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "fixed_branch=${FIXED_BRANCH}" >> $GITHUB_OUTPUT
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "base_branch=${PR_BRANCH}" >> $GITHUB_OUTPUT
        else
          echo "base_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi
      id: create_branch

    - name: Check if PR already exists
      if: steps.spotless_apply.outputs.changes == 'true'
      id: check_pr
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        FIXED_BRANCH="${{ steps.create_branch.outputs.fixed_branch }}"
        
        # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒåˆ†æ”¯çš„ PR
        EXISTING_PR=$(gh pr list --head "${FIXED_BRANCH}" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
        
        if [ -n "${EXISTING_PR}" ]; then
          echo "PR å·²å­˜åœ¨: #${EXISTING_PR}"
          echo "pr_exists=true" >> $GITHUB_OUTPUT
          echo "pr_number=${EXISTING_PR}" >> $GITHUB_OUTPUT
        else
          echo "æ²¡æœ‰æ‰¾åˆ°å·²å­˜åœ¨çš„ PR"
          echo "pr_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.spotless_apply.outputs.changes == 'true' && steps.check_pr.outputs.pr_exists == 'false'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # è®¾ç½® PR æ ‡é¢˜å’Œæ­£æ–‡
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          PR_TITLE="ğŸ”§ Spotless formatting fixes for PR #${{ github.event.pull_request.number }}"
          # ä½¿ç”¨ HEREDOC åˆ›å»ºå¤šè¡Œ PR æ­£æ–‡ï¼Œé¿å… YAML è§£æé—®é¢˜
          PR_BODY=$(cat << EOF
This PR contains automated code formatting fixes generated by Spotless.

### Related PR
- Original PR: #${{ github.event.pull_request.number }}

### Changes
- Applied code formatting fixes using Spotless
- No functional changes, only formatting

**Please merge this PR first before proceeding with the original PR.**
EOF
)
          BASE_BRANCH="${{ github.head_ref }}"
        else
          PR_TITLE="ğŸ”§ Automatic Spotless Code Formatting"
          PR_BODY=$(cat << EOF
This PR contains automated code formatting fixes generated by Spotless.

### Changes
- Applied code formatting fixes using Spotless
- No functional changes, only formatting

**This is an automated PR. Please review and merge.**
EOF
)
          BASE_BRANCH="${{ github.ref_name }}"
        fi
        
        FIXED_BRANCH="${{ steps.create_branch.outputs.fixed_branch }}"
        
        echo "åˆ›å»º PR: ${FIXED_BRANCH} -> ${BASE_BRANCH}"
        
        # åˆ›å»º PRï¼Œä¸æŒ‡å®šæ ‡ç­¾é¿å…é”™è¯¯
        gh pr create \
          --head "${FIXED_BRANCH}" \
          --base "${BASE_BRANCH}" \
          --title "${PR_TITLE}" \
          --body "${PR_BODY}" \
          --draft || echo "PR åˆ›å»ºå¤±è´¥"
        
        # å¦‚æœæ˜¯ PR äº‹ä»¶ï¼Œåœ¨åŸå§‹ PR ä¸­æ·»åŠ è¯„è®º
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          ORIGINAL_PR="${{ github.event.pull_request.number }}"
          COMMENT="ğŸ”§ **Automated Formatting Notice**

An automated formatting PR has been created to fix code style issues. Please merge the formatting PR first, then you can update this PR.

This ensures consistent code formatting across the codebase."
          
          gh pr comment "${ORIGINAL_PR}" --body "${COMMENT}" || echo "æ— æ³•æ·»åŠ è¯„è®ºåˆ°åŸå§‹ PR"
        fi

  # è‡ªåŠ¨åˆ é™¤åˆ†æ”¯å·¥ä½œæµ
  delete-branch-on-merge:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    needs: spotless-format-and-pr
    # åªæœ‰å½“æœ‰æ›´æ”¹ä¸”æˆåŠŸåˆ›å»ºäº†åˆ†æ”¯æ—¶æ‰è¿è¡Œ
    if: ${{ needs.spotless-format-and-pr.result == 'success' && needs.spotless-format-and-pr.outputs.changes == 'true' && needs.spotless-format-and-pr.outputs.fixed_branch != '' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Wait for PR merge and delete branch
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        FIXED_BRANCH="${{ needs.spotless-format-and-pr.outputs.fixed_branch }}"
        
        if [ -z "${FIXED_BRANCH}" ] || [ "${FIXED_BRANCH}" = "null" ]; then
          echo "é”™è¯¯ï¼šfixed_branch ä¸ºç©ºï¼Œæ— æ³•ç»§ç»­"
          exit 0
        fi
        
        echo "ç›‘æ§åˆ†æ”¯ ${FIXED_BRANCH} çš„ PR çŠ¶æ€..."
        
        # ç­‰å¾… PR åˆ›å»ºå®Œæˆ
        echo "ç­‰å¾… PR åˆ›å»ºå®Œæˆ..."
        sleep 30
        
        # æŸ¥æ‰¾å¯¹åº”çš„ PR
        PR_NUMBER=$(gh pr list --head "${FIXED_BRANCH}" --state all --json number --jq '.[0].number' 2>/dev/null || echo "")
        
        if [ -z "${PR_NUMBER}" ]; then
          echo "æœªæ‰¾åˆ°åˆ†æ”¯ ${FIXED_BRANCH} å¯¹åº”çš„ PR"
          echo "å¯èƒ½ PR å°šæœªåˆ›å»ºæˆ–å·²è¢«åˆ é™¤ï¼Œé€€å‡ºç›‘æ§"
          exit 0
        fi
        
        echo "æ‰¾åˆ° PR #${PR_NUMBER}ï¼Œå¼€å§‹ç›‘æ§..."
        
        # è®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆ4å°æ—¶ï¼‰
        MAX_WAIT_SECONDS=14400
        WAITED_SECONDS=0
        CHECK_INTERVAL=60
        
        # ç­‰å¾… PR åˆå¹¶æˆ–å…³é—­
        while [ ${WAITED_SECONDS} -lt ${MAX_WAIT_SECONDS} ]; do
          PR_INFO=$(gh pr view "${PR_NUMBER}" --json state,merged,closed 2>/dev/null || echo '{"state":"UNKNOWN","merged":false,"closed":false}')
          PR_STATE=$(echo "${PR_INFO}" | jq -r '.state')
          PR_MERGED=$(echo "${PR_INFO}" | jq -r '.merged')
          
          echo "PR çŠ¶æ€: ${PR_STATE}, åˆå¹¶çŠ¶æ€: ${PR_MERGED}"
          
          if [ "${PR_STATE}" = "MERGED" ] || [ "${PR_MERGED}" = "true" ]; then
            echo "PR #${PR_NUMBER} å·²åˆå¹¶ï¼Œå¼€å§‹åˆ é™¤åˆ†æ”¯ ${FIXED_BRANCH}"
            
            # åˆ é™¤æœ¬åœ°å’Œè¿œç¨‹åˆ†æ”¯
            if git show-ref --verify --quiet "refs/heads/${FIXED_BRANCH}" 2>/dev/null; then
              git push origin --delete "${FIXED_BRANCH}"
              echo "âœ… åˆ†æ”¯ ${FIXED_BRANCH} å·²æˆåŠŸåˆ é™¤"
            else
              echo "âš ï¸ åˆ†æ”¯ ${FIXED_BRANCH} ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤"
            fi
            
            exit 0
          elif [ "${PR_STATE}" = "CLOSED" ]; then
            echo "PR #${PR_NUMBER} å·²å…³é—­ä½†æœªåˆå¹¶ï¼Œä¿ç•™åˆ†æ”¯ ${FIXED_BRANCH}"
            exit 0
          fi
          
          echo "ç­‰å¾… ${CHECK_INTERVAL} ç§’åé‡è¯•... (å·²ç­‰å¾… ${WAITED_SECONDS} ç§’)"
          sleep ${CHECK_INTERVAL}
          WAITED_SECONDS=$((WAITED_SECONDS + CHECK_INTERVAL))
        done
        
        echo "â° è¾¾åˆ°æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆ4å°æ—¶ï¼‰ï¼ŒPR ä»æœªåˆå¹¶ï¼Œåœæ­¢ç›‘æ§"
        echo "åˆ†æ”¯ ${FIXED_BRANCH} å°†ä¿æŒå­˜åœ¨"
